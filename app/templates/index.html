<!-- ダッシュボード -->
{% extends "base.html" %}
{% block title %}ダッシュボード{% endblock %}
{% block content %}
  <h1 class="title">ダッシュボード</h1>
  <!-- KPI カード: 物件/入居者/契約の件数を即座に把握 -->
  <div class="columns">
    <div class="column">
      <div class="box has-text-centered">
        <p class="heading">物件数</p>
        <p class="title">{{ property_count }}</p>
      </div>
    </div>
    <div class="column">
      <div class="box has-text-centered">
        <p class="heading">入居者数</p>
        <p class="title">{{ tenant_count }}</p>
      </div>
    </div>
    <div class="column">
      <div class="box has-text-centered">
        <p class="heading">契約数</p>
        <p class="title">{{ lease_count }}</p>
      </div>
    </div>
  </div>
  <div class="box">
    <!-- 先月実績と今月予想を棒+折れ線チャートで可視化 -->
    <h2 class="subtitle">先月の物件別家賃合計・入居者数（今月予想付き）</h2>
    <div style="height: 320px;">
      <canvas id="propertyRentChart"></canvas>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (typeof Chart === "undefined") {
        return;
      }
      const propertyCtx = document.getElementById("propertyRentChart");
      if (propertyCtx) {
        const propertyLabels = {{ property_labels|tojson }};
        const propertyData = {{ property_values|tojson }};
        const propertyCounts = {{ property_counts|tojson }};
        const forecastData = {{ forecast_values|tojson }};
        const forecastCounts = {{ forecast_counts|tojson }};
        const rentValues = propertyData.concat(forecastData);
        const rentMax = rentValues.length ? Math.max(...rentValues) : 0;
        const tenantValues = propertyCounts.concat(forecastCounts);
        const tenantMax = tenantValues.length ? Math.max(...tenantValues) : 0;
        // 家賃は棒グラフ、入居者数は折れ線の複合チャート
        new Chart(propertyCtx, {
          type: "bar",
          data: {
            labels: propertyLabels,
            datasets: [
              {
                label: "家賃合計（先月実績）",
                data: propertyData,
                backgroundColor: "rgba(72, 199, 142, 0.6)",
                borderColor: "#48c78e",
                borderWidth: 1,
                yAxisID: "y",
              },
              {
                label: "家賃合計（今月予想）",
                data: forecastData,
                backgroundColor: "rgba(72, 199, 142, 0.2)",
                borderColor: "#2f9f72",
                borderWidth: 2,
                borderDash: [5, 3],
                yAxisID: "y",
              },
              {
                label: "入居者数（先月実績）",
                data: propertyCounts,
                type: "line",
                yAxisID: "y1",
                borderColor: "#ff6384",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                tension: 0.2,
                fill: false,
                pointRadius: 4,
              },
              {
                label: "入居者数（今月予想）",
                data: forecastCounts,
                type: "line",
                yAxisID: "y1",
                borderColor: "#ffa600",
                backgroundColor: "rgba(255, 166, 0, 0.2)",
                tension: 0.2,
                fill: false,
                pointRadius: 4,
                borderDash: [5, 3],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                position: "left",
                beginAtZero: true,
                suggestedMax: rentMax ? rentMax * 1.2 : 10,
                ticks: {
                  callback: (value) => `${value}万`,
                },
                title: {
                  display: true,
                  text: "万円",
                },
              },
              y1: {
                position: "right",
                beginAtZero: true,
                suggestedMax: tenantMax ? tenantMax * 1.2 : 5,
                grid: {
                  drawOnChartArea: false,
                },
                ticks: {
                  callback: (value) => `${value}件`,
                },
                title: {
                  display: true,
                  text: "入居者数",
                },
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 0,
                },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    if (ctx.dataset.yAxisID === "y") {
                      return ` ${ctx.parsed.y} 万円`;
                    }
                    return ` ${ctx.parsed.y} 件`;
                  },
                },
              },
            },
          },
        });
      }
    });
  </script>
{% endblock %}
